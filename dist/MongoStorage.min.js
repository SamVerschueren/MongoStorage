/**
 * MongoStorage v1.2.0
 * 
 * @author Sam Verschueren     <sam.verschueren@gmail.com>
 * @since  03 Jun 2015
 */
!function(r){function t(r,t){return function(){r.apply(t,arguments)}}function n(r){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof r)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],f(r,t(o,this),t(i,this))}function e(r){var t=this;return null===this._state?void this._deferreds.push(r):void c(function(){var n=t._state?r.onFulfilled:r.onRejected;if(null===n)return void(t._state?r.resolve:r.reject)(t._value);var e;try{e=n(t._value)}catch(o){return void r.reject(o)}r.resolve(e)})}function o(r){try{if(r===this)throw new TypeError("A promise cannot be resolved with itself.");if(r&&("object"==typeof r||"function"==typeof r)){var n=r.then;if("function"==typeof n)return void f(t(n,r),t(o,this),t(i,this))}this._state=!0,this._value=r,a.call(this)}catch(e){i.call(this,e)}}function i(r){this._state=!1,this._value=r,a.call(this)}function a(){for(var r=0,t=this._deferreds.length;t>r;r++)e.call(this,this._deferreds[r]);this._deferreds=null}function u(r,t,n,e){this.onFulfilled="function"==typeof r?r:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=e}function f(r,t,n){var e=!1;try{r(function(r){e||(e=!0,t(r))},function(r){e||(e=!0,n(r))})}catch(o){if(e)return;e=!0,n(o)}}var c=n.immediateFn||"function"==typeof setImmediate&&setImmediate||function(r){setTimeout(r,1)},l=Array.isArray||function(r){return"[object Array]"===Object.prototype.toString.call(r)};n.prototype["catch"]=function(r){return this.then(null,r)},n.prototype.then=function(r,t){var o=this;return new n(function(n,i){e.call(o,new u(r,t,n,i))})},n.all=function(){var r=Array.prototype.slice.call(1===arguments.length&&l(arguments[0])?arguments[0]:arguments);return new n(function(t,n){function e(i,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var u=a.then;if("function"==typeof u)return void u.call(a,function(r){e(i,r)},n)}r[i]=a,0===--o&&t(r)}catch(f){n(f)}}if(0===r.length)return t([]);for(var o=r.length,i=0;i<r.length;i++)e(i,r[i])})},n.resolve=function(r){return r&&"object"==typeof r&&r.constructor===n?r:new n(function(t){t(r)})},n.reject=function(r){return new n(function(t,n){n(r)})},n.race=function(r){return new n(function(t,n){for(var e=0,o=r.length;o>e;e++)r[e].then(t,n)})},"undefined"!=typeof module&&module.exports?module.exports=n:r.Promise||(r.Promise=n)}(this);var Collection=function(){"use strict";function r(r,t){this._name=r,this._data=t}if("undefined"==typeof _)return void console.error("Lodash not found! Please include lodash.");var t=function(){};return r.prototype.find=function(n,e,o){var i=this;return new Promise(function(a){_.isFunction(n)&&(o=n,e={},n={}),_.isFunction(e)&&(o=e,e={}),n=n||{},e=e||{},o=o||t;var u=_.filter(_.values(i._data),compileDocumentSelector(n));e.sort&&(u=u.sort(r._compileSort(e.sort)));var f=e.skip||0,c=e.limit?e.limit+f:u.length,l=u.slice(f,c);o(l),a(l)})},r.prototype.findOne=function(n,e,o){var i=this;return new Promise(function(a){_.isFunction(n)&&(o=n,e=void 0,n={}),_.isFunction(e)&&(o=e,e=void 0),n=n||{},e=e||{},o=o||t;var u=_.filter(_.values(i._data),compileDocumentSelector(n));e.sort&&(u=u.sort(r._compileSort(e.sort)));var f=u[0];o(f),a(f)})},r.prototype.update=function(n,e,o,i){var a=this;return new Promise(function(u){_.isFunction(o)&&(i=o,o={}),o=o||{},i=i||t;var f=0;if(a.find(n,function(t){o.multi||(t=0===t.length?[]:[t[0]]),_.forEach(t,function(t){r._modify(t,e,o);var n=_.findIndex(a._data,{_id:t._id});a._data[n]=t,window.localStorage.setObject(a._name,a._data),++f})}),0===f&&o.upsert){var c=n;r._modify(c,e,{isInsert:!0});try{c._id=new ObjectId(c._id).toJSONValue()}catch(l){c._id=(new ObjectId).toJSONValue()}a._data.push(c),window.localStorage.setObject(a._name,a._data),f=1}i(f),u(f)})},r.prototype.insert=function(r,n){var e=this;return new Promise(function(o){var i=_.cloneDeep(r);n=n||t,_.isArray(r)||(i=[r]),_.forEach(i,function(r){r._id=(new ObjectId).toJSONValue(),e._data.push(r)}),window.localStorage.setObject(e._name,e._data),n(),o()})},r.prototype.remove=function(r,n){var e=this;return new Promise(function(o){_.isFunction(r)&&(n=r,r=void 0),n=n||t;var i=e._data.length;r?e.find(r,function(r){i=r.length,_.each(r,function(r){var t=_.findIndex(e._data,{_id:r._id});e._data.splice(t,1)})}):e._data=[],window.localStorage.setObject(e._name,e._data),n(i),o(i)})},r.prototype.count=function(r,t){var n=this;return new Promise(function(e){_.isFunction(r)&&(t=r,r={}),n.find(r,function(r){t(r.length),e(r.length)})})},r.prototype.drop=function(r){var n=this;return new Promise(function(e){r=r||t,window.localStorage.removeItem(n._name),r(),e()})},r}();"undefined"!=typeof module&&(module.exports=Collection),Collection._modify=function(r,t,n){if(n=n||{},!_.isObject(t))throw Error("Modifier must be an object");var e,o=isOperatorObject(t);if(o)e=EJSON.clone(r),_.each(t,function(r,t){var o=MODIFIERS[t];if(n.isInsert&&"$setOnInsert"===t&&(o=MODIFIERS.$set),!o)throw Error("Invalid modifier specified "+t);_.each(r,function(r,i){if(i.length&&"."===i[i.length-1])throw Error("Invalid mod field name, may not end in a period");if("_id"===i)throw Error("Mod on _id not allowed");var a=i.split("."),u=(_.has(NO_CREATE_MODIFIERS,t),findModTarget(e,a,{noCreate:NO_CREATE_MODIFIERS[t],forbidArray:"$rename"===t,arrayIndices:n.arrayIndices})),f=a.pop();o(u,f,r,i,e)})});else{if(t._id&&!EJSON.equals(r._id,t._id))throw Error("Cannot change the _id of a document");for(var i in t)if(/\./.test(i))throw Error("When replacing document, field name may not contain '.'");e=t}_.each(_.keys(r),function(t){("_id"!==t||n.isInsert)&&delete r[t]}),_.each(e,function(t,n){r[n]=t})};var findModTarget=function(r,t,n){n=n||{};for(var e=!1,o=0;o<t.length;o++){var i=o===t.length-1,a=t[o],u=isIndexable(r);if(!u){if(n.noCreate)return void 0;var f=Error("cannot use the part '"+a+"' to traverse "+r);throw f.setPropertyError=!0,f}if(r instanceof Array){if(n.forbidArray)return null;if("$"===a){if(e)throw Error("Too many positional (i.e. '$') elements");if(!n.arrayIndices||!n.arrayIndices.length)throw Error("The positional operator did not find the match needed from the query");a=n.arrayIndices[0],e=!0}else{if(!isNumericKey(a)){if(n.noCreate)return void 0;throw Error("can't append to array using string field name ["+a+"]")}a=parseInt(a)}if(i&&(t[o]=a),n.noCreate&&a>=r.length)return void 0;for(;r.length<a;)r.push(null);if(!i)if(r.length===a)r.push({});else if("object"!=typeof r[a])throw Error("can't modify field '"+t[o+1]+"' of list value "+JSON.stringify(r[a]))}else{if(a.length&&"$"===a.substr(0,1))throw Error("can't set field named "+a);if(!(a in r)){if(n.noCreate)return void 0;i||(r[a]={})}}if(i)return r;r=r[a]}},NO_CREATE_MODIFIERS={$unset:!0,$pop:!0,$rename:!0,$pull:!0,$pullAll:!0},MODIFIERS={$inc:function(r,t,n){if("number"!=typeof n)throw Error("Modifier $inc allowed for numbers only");if(t in r){if("number"!=typeof r[t])throw Error("Cannot apply $inc modifier to non-number");r[t]+=n}else r[t]=n},$set:function(r,t,n){if(!_.isObject(r)){var e=Error("Cannot set property on non-object field");throw e.setPropertyError=!0,e}if(null===r){var e=Error("Cannot set property on null");throw e.setPropertyError=!0,e}r[t]=EJSON.clone(n)},$setOnInsert:function(r,t,n){},$unset:function(r,t,n){console.log("unset"),void 0!==r&&(r instanceof Array?t in r&&(r[t]=null):delete r[t])},$push:function(r,t,n){if(void 0===r[t]&&(r[t]=[]),!(r[t]instanceof Array))throw Error("Cannot apply $push modifier to non-array");if(!n||!n.$each)return void r[t].push(EJSON.clone(n));var e=n.$each;if(!(e instanceof Array))throw Error("$each must be an array");var o=void 0;if("$slice"in n){if("number"!=typeof n.$slice)throw Error("$slice must be a numeric value");if(n.$slice>0)throw Error("$slice in $push must be zero or negative");o=n.$slice}var i=void 0;if(n.$sort){if(void 0===o)throw Error("$sort requires $slice to be present");i=new Minimongo.Sorter(n.$sort).getComparator();for(var a=0;a<e.length;a++)if(3!==Collection._f._type(e[a]))throw Error("$push like modifiers using $sort require all elements to be objects")}for(var u=0;u<e.length;u++)r[t].push(EJSON.clone(e[u]));i&&r[t].sort(i),void 0!==o&&(r[t]=0===o?[]:r[t].slice(o))},$pushAll:function(r,t,n){if(!("object"==typeof n&&n instanceof Array))throw Error("Modifier $pushAll/pullAll allowed for arrays only");var e=r[t];if(void 0===e)r[t]=n;else{if(!(e instanceof Array))throw Error("Cannot apply $pushAll modifier to non-array");for(var o=0;o<n.length;o++)e.push(n[o])}},$addToSet:function(r,t,n){var e=!1;if("object"==typeof n)for(var o in n){"$each"===o&&(e=!0);break}var i=e?n.$each:[n],a=r[t];if(void 0===a)r[t]=i;else{if(!(a instanceof Array))throw Error("Cannot apply $addToSet modifier to non-array");_.each(i,function(r){for(var t=0;t<a.length;t++)if(Collection._f._equal(r,a[t]))return;a.push(EJSON.clone(r))})}},$pop:function(r,t,n){if(void 0!==r){var e=r[t];if(void 0!==e){if(!(e instanceof Array))throw Error("Cannot apply $pop modifier to non-array");"number"==typeof n&&0>n?e.splice(0,1):e.pop()}}},$pull:function(r,t,n){if(void 0!==r){var e=r[t];if(void 0!==e){if(!(e instanceof Array))throw Error("Cannot apply $pull/pullAll modifier to non-array");var o=[];if("object"!=typeof n||n instanceof Array)for(var i=0;i<e.length;i++)Collection._f._equal(e[i],n)||o.push(e[i]);else for(var a=new Minimongo.Matcher(n),i=0;i<e.length;i++)a.documentMatches(e[i]).result||o.push(e[i]);r[t]=o}}},$pullAll:function(r,t,n){if(!("object"==typeof n&&n instanceof Array))throw Error("Modifier $pushAll/pullAll allowed for arrays only");if(void 0!==r){var e=r[t];if(void 0!==e){if(!(e instanceof Array))throw Error("Cannot apply $pull/pullAll modifier to non-array");for(var o=[],i=0;i<e.length;i++){for(var a=!1,u=0;u<n.length;u++)if(Collection._f._equal(e[i],n[u])){a=!0;break}a||o.push(e[i])}r[t]=o}}},$rename:function(r,t,n,e,o){if(e===n)throw Error("$rename source must differ from target");if(null===r)throw Error("$rename source field invalid");if("string"!=typeof n)throw Error("$rename target must be a string");if(void 0!==r){var i=r[t];delete r[t];var a=n.split("."),u=findModTarget(o,a,{forbidArray:!0});if(null===u)throw Error("$rename target field invalid");var f=a.pop();u[f]=i}},$bit:function(r,t,n){throw Error("$bit is not supported")}};isArray=function(r){return _.isArray(r)&&!EJSON.isBinary(r)},isPlainObject=Collection._isPlainObject=function(r){return r&&_.isObject(r)},isIndexable=function(r){return isArray(r)||isPlainObject(r)},isOperatorObject=function(r,t){if(!isPlainObject(r))return!1;var n=void 0;return _.each(r,function(e,o){var i="$"===o.substr(0,1);if(void 0===n)n=i;else if(n!==i){if(!t)throw new Error("Inconsistent operator: "+JSON.stringify(r));n=!1}}),!!n},isNumericKey=function(r){return/^[0-9]+$/.test(r)};var isArray=function(r){return _.isArray(r)&&!EJSON.isBinary(r)},_anyIfArray=function(r,t){return isArray(r)?_.any(r,t):t(r)},_anyIfArrayPlus=function(r,t){return t(r)?!0:isArray(r)&&_.any(r,t)},hasOperators=function(r){var t=void 0;for(var n in r){var e="$"===n.substr(0,1);if(void 0===t)t=e;else if(t!==e)throw new Error("Inconsistent selector: "+r)}return!!t},compileValueSelector=function(r){if(null==r)return function(r){return _anyIfArray(r,function(r){return null==r})};if(!_.isObject(r))return function(t){return _anyIfArray(t,function(t){return t===r})};if(r instanceof RegExp)return function(t){return void 0===t?!1:_anyIfArray(t,function(t){return r.test(t)})};if(isArray(r))return function(t){return isArray(t)?_anyIfArrayPlus(t,function(t){return Collection._f._equal(r,t)}):!1};if(hasOperators(r)){var t=[];return _.each(r,function(n,e){if(!_.has(VALUE_OPERATORS,e))throw new Error("Unrecognized operator: "+e);t.push(VALUE_OPERATORS[e](n,r.$options))}),function(r){return _.all(t,function(t){return t(r)})}}return function(t){return _anyIfArray(t,function(t){return Collection._f._equal(r,t)})}},LOGICAL_OPERATORS={$and:function(r){if(!isArray(r)||_.isEmpty(r))throw Error("$and/$or/$nor must be nonempty array");var t=_.map(r,compileDocumentSelector);return function(r){return _.all(t,function(t){return t(r)})}},$or:function(r){if(!isArray(r)||_.isEmpty(r))throw Error("$and/$or/$nor must be nonempty array");var t=_.map(r,compileDocumentSelector);return function(r){return _.any(t,function(t){return t(r)})}},$nor:function(r){if(!isArray(r)||_.isEmpty(r))throw Error("$and/$or/$nor must be nonempty array");var t=_.map(r,compileDocumentSelector);return function(r){return _.all(t,function(t){return!t(r)})}},$where:function(r){return r instanceof Function||(r=Function("return "+r)),function(t){return r.call(t)}}},VALUE_OPERATORS={$in:function(r){if(!isArray(r))throw new Error("Argument to $in must be array");return function(t){return _anyIfArrayPlus(t,function(t){return _.any(r,function(r){return Collection._f._equal(r,t)})})}},$all:function(r){if(!isArray(r))throw new Error("Argument to $all must be array");return function(t){return isArray(t)?_.all(r,function(r){return _.any(t,function(t){return Collection._f._equal(r,t)})}):!1}},$lt:function(r){return function(t){return _anyIfArray(t,function(t){return Collection._f._cmp(t,r)<0})}},$lte:function(r){return function(t){return _anyIfArray(t,function(t){return Collection._f._cmp(t,r)<=0})}},$gt:function(r){return function(t){return _anyIfArray(t,function(t){return Collection._f._cmp(t,r)>0})}},$gte:function(r){return function(t){return _anyIfArray(t,function(t){return Collection._f._cmp(t,r)>=0})}},$ne:function(r){return function(t){return!_anyIfArrayPlus(t,function(t){return Collection._f._equal(t,r)})}},$nin:function(r){if(!isArray(r))throw new Error("Argument to $nin must be array");var t=VALUE_OPERATORS.$in(r);return function(r){return void 0===r?!0:!t(r)}},$exists:function(r){return function(t){return r===(void 0!==t)}},$mod:function(r){var t=r[0],n=r[1];return function(r){return _anyIfArray(r,function(r){return r%t===n})}},$size:function(r){return function(t){return isArray(t)&&r===t.length}},$type:function(r){return function(t){return void 0===t?!1:_anyIfArray(t,function(t){return Collection._f._type(t)===r})}},$regex:function(r,t){if(void 0!==t){if(/[^gim]/.test(t))throw new Error("Only the i, m, and g regexp options are supported");var n=r instanceof RegExp?r.source:r;r=new RegExp(n,t)}else r instanceof RegExp||(r=new RegExp(r));return function(t){return void 0===t?!1:_anyIfArray(t,function(t){return r.test(t)})}},$options:function(r){return function(r){return!0}},$elemMatch:function(r){var t=compileDocumentSelector(r);return function(r){return isArray(r)?_.any(r,function(r){return t(r)}):!1}},$not:function(r){var t=compileValueSelector(r);return function(r){return!t(r)}},$near:function(r){return function(r){return!0}},$geoIntersects:function(r){return function(r){return!0}}};Collection._f={_type:function(r){return"number"==typeof r?1:"string"==typeof r?2:"boolean"==typeof r?8:isArray(r)?4:null===r?10:r instanceof RegExp?11:"function"==typeof r?13:r instanceof Date?9:EJSON.isBinary(r)?5:r instanceof Meteor.Collection.ObjectID?7:3},_equal:function(r,t){return EJSON.equals(r,t,{keyOrderSensitive:!0})},_typeorder:function(r){return[-1,1,2,3,4,5,-1,6,7,8,0,9,-1,100,2,100,1,8,1][r]},_cmp:function(r,t){if(void 0===r)return void 0===t?0:-1;if(void 0===t)return 1;var n=Collection._f._type(r),e=Collection._f._type(t),o=Collection._f._typeorder(n),i=Collection._f._typeorder(e);if(o!==i)return i>o?-1:1;if(n!==e)throw Error("Missing type coercion logic in _cmp");if(7===n&&(n=e=2,r=r.toHexString(),t=t.toHexString()),9===n&&(n=e=1,r=r.getTime(),t=t.getTime()),1===n)return r-t;if(2===e)return t>r?-1:r===t?0:1;if(3===n){var a=function(r){var t=[];for(var n in r)t.push(n),t.push(r[n]);return t};return Collection._f._cmp(a(r),a(t))}if(4===n)for(var u=0;;u++){if(u===r.length)return u===t.length?0:-1;if(u===t.length)return 1;var f=Collection._f._cmp(r[u],t[u]);if(0!==f)return f}if(5===n){if(r.length!==t.length)return r.length-t.length;for(u=0;u<r.length;u++){if(r[u]<t[u])return-1;if(r[u]>t[u])return 1}return 0}if(8===n)return r?t?0:1:t?-1:0;if(10===n)return 0;if(11===n)throw Error("Sorting not supported on regular expression");if(13===n)throw Error("Sorting not supported on Javascript code");throw Error("Unknown type to sort")}},Collection._matches=function(r,t){return Collection._compileSelector(r)(t)},Collection._makeLookupFunction=function(r){var t,n,e,o=r.indexOf(".");if(-1===o)t=r;else{t=r.substr(0,o);var i=r.substr(o+1);n=Collection._makeLookupFunction(i),e=/^\d+(\.|$)/.test(i)}return function(r){if(null==r)return[void 0];var o=r[t];return n?isArray(o)&&0===o.length?[void 0]:((!isArray(o)||e)&&(o=[o]),Array.prototype.concat.apply([],_.map(o,n))):[o]}};var compileDocumentSelector=function(r){var t=[];return _.each(r,function(r,n){if("$"===n.substr(0,1)){if(!_.has(LOGICAL_OPERATORS,n))throw new Error("Unrecognized logical operator: "+n);t.push(LOGICAL_OPERATORS[n](r))}else{var e=Collection._makeLookupFunction(n),o=compileValueSelector(r);t.push(function(r){var t=e(r);return _.any(t,o)})}}),function(r){return _.all(t,function(t){return t(r)})}};Collection._compileSelector=function(r){if(r instanceof Function)return function(t){return r.call(t)};if(Collection._selectorIsId(r))return function(t){return EJSON.equals(t._id,r)};if(!r||"_id"in r&&!r._id)return function(r){return!1};if("boolean"==typeof r||isArray(r)||EJSON.isBinary(r))throw new Error("Invalid selector: "+r);return compileDocumentSelector(r)},Collection._compileSort=function(r){var t=[];if(r instanceof Array)for(var n=0;n<r.length;n++)t.push("string"==typeof r[n]?{lookup:Collection._makeLookupFunction(r[n]),ascending:!0}:{lookup:Collection._makeLookupFunction(r[n][0]),ascending:"desc"!==r[n][1]});else{if("object"!=typeof r)throw Error("Bad sort specification: ",JSON.stringify(r));for(var e in r)t.push({lookup:Collection._makeLookupFunction(e),ascending:r[e]>=0})}if(0===t.length)return function(){return 0};var o=function(r,t){var n,e=!0;return _.each(r,function(r){isArray(r)||(r=[r]),isArray(r)&&0===r.length&&(r=[void 0]),_.each(r,function(r){if(e)n=r,e=!1;else{var o=Collection._f._cmp(n,r);(t&&o>0||!t&&0>o)&&(n=r)}})}),n};return function(r,n){for(var e=0;e<t.length;++e){var i=t[e],a=o(i.lookup(r),i.ascending),u=o(i.lookup(n),i.ascending),f=Collection._f._cmp(a,u);if(0!==f)return i.ascending?f:-f}return 0}},EJSON={};var customTypes={};EJSON.addType=function(r,t){if(_.has(customTypes,r))throw new Error("Type "+r+" already present");customTypes[r]=t};var builtinConverters=[{matchJSONValue:function(r){return _.has(r,"$date")&&1===_.size(r)},matchObject:function(r){return r instanceof Date},toJSONValue:function(r){return{$date:r.getTime()}},fromJSONValue:function(r){return new Date(r.$date)}},{matchJSONValue:function(r){return _.has(r,"$binary")&&1===_.size(r)},matchObject:function(r){return"undefined"!=typeof Uint8Array&&r instanceof Uint8Array||r&&_.has(r,"$Uint8ArrayPolyfill")},toJSONValue:function(r){return{$binary:EJSON._base64Encode(r)}},fromJSONValue:function(r){return EJSON._base64Decode(r.$binary)}},{matchJSONValue:function(r){return _.has(r,"$escape")&&1===_.size(r)},matchObject:function(r){return _.isEmpty(r)||_.size(r)>2?!1:_.any(builtinConverters,function(t){return t.matchJSONValue(r)})},toJSONValue:function(r){var t={};return _.each(r,function(r,n){t[n]=EJSON.toJSONValue(r)}),{$escape:t}},fromJSONValue:function(r){var t={};return _.each(r.$escape,function(r,n){t[n]=EJSON.fromJSONValue(r)}),t}},{matchJSONValue:function(r){return _.has(r,"$type")&&_.has(r,"$value")&&2===_.size(r)},matchObject:function(r){return EJSON._isCustomType(r)},toJSONValue:function(r){return{$type:r.typeName(),$value:r.toJSONValue()}},fromJSONValue:function(r){var t=r.$type,n=customTypes[t];return n(r.$value)}}];EJSON._isCustomType=function(r){return r&&"function"==typeof r.toJSONValue&&"function"==typeof r.typeName&&_.has(customTypes,r.typeName())};var adjustTypesToJSONValue=EJSON._adjustTypesToJSONValue=function(r){if(null===r)return null;var t=toJSONValueHelper(r);return void 0!==t?t:(_.each(r,function(t,n){if("object"==typeof t||void 0===t){var e=toJSONValueHelper(t);return e?void(r[n]=e):void adjustTypesToJSONValue(t)}}),r)},toJSONValueHelper=function(r){for(var t=0;t<builtinConverters.length;t++){var n=builtinConverters[t];if(n.matchObject(r))return n.toJSONValue(r)}return void 0};EJSON.toJSONValue=function(r){var t=toJSONValueHelper(r);return void 0!==t?t:("object"==typeof r&&(r=EJSON.clone(r),adjustTypesToJSONValue(r)),r)};var adjustTypesFromJSONValue=EJSON._adjustTypesFromJSONValue=function(r){if(null===r)return null;var t=fromJSONValueHelper(r);return t!==r?t:(_.each(r,function(t,n){if("object"==typeof t){var e=fromJSONValueHelper(t);if(t!==e)return void(r[n]=e);adjustTypesFromJSONValue(t)}}),r)},fromJSONValueHelper=function(r){if("object"==typeof r&&null!==r&&_.size(r)<=2&&_.all(r,function(r,t){return"string"==typeof t&&"$"===t.substr(0,1)}))for(var t=0;t<builtinConverters.length;t++){var n=builtinConverters[t];if(n.matchJSONValue(r))return n.fromJSONValue(r)}return r};EJSON.fromJSONValue=function(r){var t=fromJSONValueHelper(r);return t===r&&"object"==typeof r?(r=EJSON.clone(r),adjustTypesFromJSONValue(r),r):t},EJSON.stringify=function(r){return JSON.stringify(EJSON.toJSONValue(r))},EJSON.parse=function(r){return EJSON.fromJSONValue(JSON.parse(r))},EJSON.isBinary=function(r){return"undefined"!=typeof Uint8Array&&r instanceof Uint8Array||r&&r.$Uint8ArrayPolyfill},EJSON.equals=function(r,t,n){var e,o=!(!n||!n.keyOrderSensitive);if(r===t)return!0;if(!r||!t)return!1;if("object"!=typeof r||"object"!=typeof t)return!1;if(r instanceof Date&&t instanceof Date)return r.valueOf()===t.valueOf();if(EJSON.isBinary(r)&&EJSON.isBinary(t)){if(r.length!==t.length)return!1;for(e=0;e<r.length;e++)if(r[e]!==t[e])return!1;return!0}if("function"==typeof r.equals)return r.equals(t,n);if(r instanceof Array){if(!(t instanceof Array))return!1;if(r.length!==t.length)return!1;for(e=0;e<r.length;e++)if(!EJSON.equals(r[e],t[e],n))return!1;return!0}var i;if(o){var a=[];return _.each(t,function(r,t){a.push(t)}),e=0,i=_.all(r,function(r,o){return e>=a.length?!1:o!==a[e]?!1:EJSON.equals(r,t[a[e]],n)?(e++,!0):!1}),i&&e===a.length}return e=0,i=_.all(r,function(r,o){return _.has(t,o)&&EJSON.equals(r,t[o],n)?(e++,!0):!1}),i&&_.size(t)===e},EJSON.clone=function(r){var t;if("object"!=typeof r)return r;if(null===r)return null;if(r instanceof Date)return new Date(r.getTime());if(EJSON.isBinary(r)){t=EJSON.newBinary(r.length);for(var n=0;n<r.length;n++)t[n]=r[n];return t}if(_.isArray(r)||_.isArguments(r)){for(t=[],n=0;n<r.length;n++)t[n]=EJSON.clone(r[n]);return t}return"function"==typeof r.clone?r.clone():(t={},_.each(r,function(r,n){t[n]=EJSON.clone(r)}),t)},Storage.prototype.setObject=function(r,t){this.setItem(r,EJSON.stringify(t))},Storage.prototype.getObject=function(r){var t=this.getItem(r);return t?EJSON.parse(t):void 0};var MongoStorage=function(){"use strict";function r(){}return"undefined"==typeof _?void console.error("Lodash not found! Please include lodash."):(r.prototype.use=function(r){_.forEach(Object.keys(this),function(r){delete this[r]},this),this._database=r;for(var t in window.localStorage)t.split(".")[0]===this._database&&(this[t.substring(this._database.length+1)]=new Collection(t,window.localStorage.getObject(t)))},r.prototype.createCollection=function(r){if(void 0===this._database)throw{errmsg:"no database selected",ok:0};var t=this._database+"."+r;if(void 0!==window.localStorage[t])throw{errmsg:"collection already exists",ok:0};window.localStorage.setObject(t,[]),this[r]=new Collection(t,[])},r.prototype.dropDatabase=function(){if(void 0===this._database)throw{errmsg:"no database selected",ok:0};_.forEach(this.collections(),function(r){delete window.localStorage[this._database+"."+r]},this),this.use()},r.prototype.collections=function(){if(void 0===this._database)throw{errmsg:"no database selected",ok:0};var r=[];for(var t in window.localStorage){var n=t.split(".");n.shift()===this._database&&r.push(n.join("."))}return r},r)}(),ObjectId=function(){"use strict";function r(r){if(r){if(r=r.toLowerCase(),!this._isObjectId(r))throw new Error("Could not parse "+r+" as a hexadecimal string");this._timestamp=parseInt(r.substr(0,8),16),this._id=r}else{for(this._timestamp=parseInt(Date.now()/1e3),this._index=(t++).toString(16);this._index.length<6;)this._index="0"+this._index;this._id=this._timestamp.toString(16)+n+e+this._index}}var t=_.random(0,5592405),n=_.random(1048576,16777215).toString(16),e=_.random(4096,65535).toString(16);return r.prototype._isObjectId=function(r){return 24===r.length&&!!r.match(/^[0-9a-f]*$/)},r.prototype.getTimestamp=function(){return this._timestamp},r.prototype.toString=function(){return'ObjectId("'+this._id+'")'},r.prototype.valueOf=r.prototype.toJSONValue=r.prototype.toHexString=function(){return this._id},r}();
//# sourceMappingURL=MongoStorage.min.js.map